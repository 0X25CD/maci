<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Minimum Anti-Collusion Infrastructure</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="circuits.html"><strong aria-hidden="true">3.</strong> Circuits</a></li><li class="chapter-item expanded "><a href="trustedsetup.html"><strong aria-hidden="true">4.</strong> Trusted setup</a></li><li class="chapter-item expanded "><a href="testing.html"><strong aria-hidden="true">5.</strong> Testing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Minimum Anti-Collusion Infrastructure</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Minimum Anti-Collusion Infrastructure (MACI) is a base layer for
bribery-resistant, secure, and private digital voting.</p>
<p>The documentation here pertains to version 1.0, temporarily located in the <code>v1</code>
branch.</p>
<p>Applications like <a href="https://clr.fund/">clr.fund</a> build atop MACI to increase
privacy and discourage bribery for public goods funding.</p>
<p>MACI offers the following guarantees:</p>
<ul>
<li><strong>Collusion resistance</strong>: no-one except a trusted coordinator should be
certain of the validity of a vote, reducing the effectiveness of bribery.</li>
<li><strong>Receipt-freeness</strong>: no-one voter prove (besides to the coordinator) which
way they voted.</li>
<li><strong>Privacy</strong>: no-one except a trusted coordinator should be able to decrypt a
vote.</li>
<li><strong>Uncensorability</strong>: no-one — not even the trusted coordinator — should be
able to censor a vote.</li>
<li><strong>Unforgeability</strong>: only the owner of a user's private key may cast a vote
tied to its corresponding public key.</li>
<li><strong>Non-repudiation</strong>: no-one may modify or delete a vote after it is cast,
although a user may cast another vote to nullify it.</li>
<li><strong>Correct execution</strong>: no-one — not even the trusted coordinator — should be
able to produce a false tally of votes.</li>
</ul>
<p>Under the hood, MACI uses Ethereum smart contracts and zero-knowledge proofs.
It inherits security and uncensorability from the underlying Ethereum
blockchain, ensures unforgeability via asymmetric encryption, and achieves
collusion resistance, privacy, and correct execution via zk-SNARK proofs.</p>
<p>Although MACI can provide collusion resistance only if the coordinator is
honest, a dishonest coordinator can neither censor nor tamper with its
execution.</p>
<p>Note that MACI presumes an identity system where each legitimate member
controls a unique Ethereum private key.</p>
<p>MACI was originally proposed by Vitalik Buterin in <a href="https://ethresear.ch/t/minimal-anti-collusion-infrastructure/5413">this ethresear.ch
post</a>.</p>
<h2 id="credits"><a class="header" href="#credits">Credits</a></h2>
<ul>
<li><a href="https://github.com/barryWhiteHat">Barry WhiteHat</a></li>
<li><a href="https://github.com/corydickson">Cory Dickson</a></li>
<li><a href="https://twitter.com/ChihChengLiang">Chih-Cheng Liang</a></li>
<li><a href="https://han0110.github.io/">Han Jian</a></li>
<li><a href="https://kndrck.co/">Kendrick Tan</a></li>
<li><a href="https://github.com/xuhcc">Kirill Goncharov</a></li>
<li><a href="http://kobi.one/">Kobi Gurkan</a></li>
<li><a href="https://kohweijie.com">Koh Wei Jie</a></li>
</ul>
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>You need the following to use MACI:</p>
<ul>
<li>An x86-64 system</li>
<li>A Linux system, preferably a Debian-based distribution like Ubuntu</li>
<li>NodeJS. Use <a href="https://github.com/nvm-sh/nvm"><code>nvm</code></a> to install it. MACI has
been tested with Node 15.</li>
<li>The <code>libgmp-dev</code> <code>nlohmann-json3-dev</code> <code>nasm</code> and <code>g++</code> Debian/Ubuntu
packages. They are needed to run <code>circom-helper</code>, which in turn is used to
develop and test zk-SNARK circuits.</li>
<li>The <a href="https://github.com/iden3/rapidsnark"><code>rapidsnark</code></a> tool.</li>
</ul>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<h3 id="install-rapidsnark"><a class="header" href="#install-rapidsnark">Install <code>rapidsnark</code></a></h3>
<p>First, install dependencies:</p>
<pre><code class="language-bash">sudo apt-get install build-essential libgmp-dev libsodium-dev nasm git
</code></pre>
<p>Next, clone <code>rapidsnark</code> and build it:</p>
<pre><code class="language-bash">git clone https://github.com/iden3/rapidsnark.git &amp;&amp; \
cd rapidsnark &amp;&amp; \
git checkout 1c13721de4a316b0b254c310ccec9341f5e2208e

npm install &amp;&amp; \
git submodule init &amp;&amp; \
git submodule update &amp;&amp; \
npx task createFieldSources &amp;&amp; \
npx task buildProver
</code></pre>
<p>Note the location of the <code>rapidsnark</code> binary (e.g.
<code>/home/user/rapidsnark/build/prover</code>).</p>
<h3 id="install-maci"><a class="header" href="#install-maci">Install MACI</a></h3>
<pre><code class="language-bash">git clone https://github.com/appliedzkp/maci.git &amp;&amp; \
cd maci &amp;&amp; \
npm i &amp;&amp; \
npm run bootstrap &amp;&amp; \
npm run build
</code></pre>
<p>Install dependencies for <code>circom-helper</code> and <code>zkey-manager</code>:</p>
<pre><code class="language-bash">sudo apt-get install libgmp-dev nlohmann-json3-dev nasm g++
</code></pre>
<h3 id="download-zkey-files"><a class="header" href="#download-zkey-files">Download <code>.zkey</code> files</a></h3>
<p>MACI has two zk-SNARK circuits. Each circuit is parameterised. There should one
<code>.zkey</code> file for each circuit and set of parameters.</p>
<p>Unless you wish to generate a fresh set of <code>.zkey</code> files, you should obtain
them from someone who has performed a multi-party trusted setup for said
circuits..</p>
<p>Note the locations of the <code>.zkey</code> files as the CLI requires them as
command-line flags.</p>
<h1 id="circuits"><a class="header" href="#circuits">Circuits</a></h1>
<p>MACI has two zk-SNARK circuits:</p>
<ol>
<li><code>ProcessMessages.circom</code>, which takes a batch of messages, and updates the
state and ballot trees according to the contents of said messages.</li>
<li><code>TallyVotes.circom</code>, which counts votes from users' ballots, batch by batch.</li>
</ol>
<p>Each circuit is parameterised and it is important to set the right parameters
to your use case. For example, if you want to support up to 3125 messages, the message tree depth parameter should be set to <code>5</code> (as \(5^5 = 3125\)).</p>
<p>Next, navigate to the <code>cli/</code> directory and edit <code>zkeys.config.yml</code>.</p>
<p>This config file defines the parameters required for MACI's circuits.</p>
<h3 id="message-processing"><a class="header" href="#message-processing">Message processing</a></h3>
<table><thead><tr><th>#</th><th>Parameter</th><th>Description</th></tr></thead><tbody>
<tr><td>0</td><td>State tree depth</td><td>Should be set to 10. Allows 9,765,625 signups.</td></tr>
<tr><td>1</td><td>Message tree depth</td><td>Allows \(5^{n}\) votes or key-change messages.</td></tr>
<tr><td>2</td><td>Message batch tree depth</td><td>Allows \(5^{n}\) messages to be processed per batch.</td></tr>
<tr><td>3</td><td>Vote option tree depth</td><td>Allows \(5^{n}\) vote options.</td></tr>
</tbody></table>
<h3 id="vote-tallying"><a class="header" href="#vote-tallying">Vote tallying</a></h3>
<table><thead><tr><th>#</th><th>Parameter</th><th>Description</th></tr></thead><tbody>
<tr><td>0</td><td>State tree depth</td><td>Should be set to 10. Allows 9,765,625 signups.</td></tr>
<tr><td>1</td><td>State leaf batch depth</td><td>Allows \(5^{n}\) users' votes to be processed per batch.</td></tr>
<tr><td>2</td><td>Message batch tree depth</td><td>Allows \(5^{n}\) messages to be processed per batch.</td></tr>
</tbody></table>
<h2 id="compile-circuits"><a class="header" href="#compile-circuits">Compile circuits</a></h2>
<p>Run:</p>
<pre><code class="language-bash">npx zkey-manager compile -c ./zkeys.config.yml
</code></pre>
<p>The larger the trees, the more time this process may take. You may also need a
machine with a very large amount of memory.</p>
<h2 id="measure-the-circuit-sizes"><a class="header" href="#measure-the-circuit-sizes">Measure the circuit sizes</a></h2>
<p>The size of a circuit is denoted by its number of constraints. The larger this
number, the more time it takes to compile it, generate its <code>.zkey</code> file, and
perform phase 2 contributions.</p>
<p>Run this command to measure a circuit:</p>
<pre><code class="language-bash">npx snarkjs r1cs info CIRCUIT_NAME.circom
</code></pre>
<h2 id="download-the-ptau-file"><a class="header" href="#download-the-ptau-file">Download the <code>.ptau</code> file</a></h2>
<p>This file should be the result of the Perpetual Powers of Tau trusted setup
contribution which <a href="https://blog.hermez.io/hermez-cryptographic-setup/">Hermez Network
selected</a>.</p>
<p>Run:</p>
<pre><code class="language-bash">npx zkey-manager downloadPtau -c ./zkeys.config.yml
</code></pre>
<p><code>zkey-manager</code> will select the smallest <code>.ptau</code> file that fits the largest
circuit specified in <code>zkeys.config.yml</code>. </p>
<h2 id="generate-zkey-files"><a class="header" href="#generate-zkey-files">Generate <code>.zkey</code> files</a></h2>
<p>Run:</p>
<pre><code class="language-bash">npx zkey-manager genZkeys -c ./zkeys.config.yml
</code></pre>
<p>This generates the initial <code>.zkey</code> files for each circuit.</p>
<p>You should perform at least one contribution to each circuit, even if you
choose not to perform a multi-party trusted setup.</p>
<h1 id="trusted-setup"><a class="header" href="#trusted-setup">Trusted setup</a></h1>
<p>MACI currently uses Groth16 zk-SNARKs written in <code>circom</code>. Teams who wish to
build on MACI may choose to perform a multi-party trusted setup. This allows
observers to have a higher degree of confidence that the coordinator cannot
generate fake proofs. Some teams, however, may forgo the trusted setup.</p>
<p>There are two possible reasons for doing so: if a team does not intend
to manage a large amount of value, and if their users accept that the risk of
coordinator misbehaviour is insufficient to justify doing the work nof a
trusted setup. After all, MACI's security model presumes a trusted coordinator.</p>
<p>In any case, MACI can be relatively easily modified to support PLONK, which
does not require a circuit-specific trusted setup. Its circuits, written in
<a href="https://github.com/iden3/circom"><code>circom</code></a>, are compatible with Fluidex's
<a href="https://github.com/Fluidex/plonkit"><code>plonkit</code></a> tool. The downside to using
PLONK is that proof generation is not as optimised as it is for Groth16.</p>
<h2 id="how-to-run-the-trusted-setup"><a class="header" href="#how-to-run-the-trusted-setup">How to run the trusted setup</a></h2>
<p>First, follow the instructions in the <a href="./installation.html">Installation</a>
section to install dependencies for MACI.</p>
<p>Next, configure and compile circuits following instructions in
<a href="./circuits.html">Circuits</a>.</p>
<p>Finally, use the <a href="https://github.com/appliedzkp/multisetups"><code>multisetups</code></a>
tool to do this.</p>
<p>You should perform at least one contribution to each circuit, even if you
choose not to perform a multi-party trusted setup.</p>
<p>We don't recommend a browser-based trusted setup (which <a href="https://ceremony.tornado.cash/">Tornado
Cash</a> and <a href="https://mpc.zkopru.network/">Zkopru</a>
used) for the MACI circuits as they are too large to be feasibly processed in
the browser.</p>
<h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<h2 id="contracts"><a class="header" href="#contracts">Contracts</a></h2>
<p>First, compile the contracts.</p>
<p>From the main <code>maci/</code> directory, run:</p>
<pre><code class="language-bash">cd contracts &amp;&amp; \
npm run compileSol
</code></pre>
<p>Run Hardhat Network (a local Ethereum testnet) in a separate terminal:</p>
<pre><code class="language-bash">cd contracts &amp;&amp; \
npm run hardhat
</code></pre>
<h2 id="cli"><a class="header" href="#cli">CLI</a></h2>
<p>You can test the CLI locally. First, you need to either generate <code>.zkey</code> files,
or download them. Do not use these testing <code>.zkey</code> files in production.</p>
<h3 id="download-zkey-files-1"><a class="header" href="#download-zkey-files-1">Download <code>.zkey</code> files</a></h3>
<p>MACI has two zk-SNARK circuits. Each circuit is parameterised. There should one
<code>.zkey</code> file for each circuit and set of parameters.</p>
<p>Unless you wish to generate a fresh set of <code>.zkey</code> files, you should obtain
them from someone who has performed a multi-party trusted setup for said
circuits..</p>
<p>Note the locations of the <code>.zkey</code> files as the CLI requires them as
command-line flags.</p>
<p>From the main <code>maci/</code> directory, run:</p>
<pre><code class="language-bash">cd cli &amp;&amp;
mkdir -p zkeys &amp;&amp; \
wget -O zkeys/ProcessMessages_10-2-1-2.test.0.zkey https://macitestcircuits.blob.core.windows.net/test/ProcessMessages_10-2-1-2.test.0.zkey &amp;&amp; \
wget -O zkeys/TallyVotes_10-1-2.test.0.zkey https://macitestcircuits.blob.core.windows.net/test/TallyVotes_10-1-2.test.0.zkey
</code></pre>
<h3 id="compile-or-download-the-witness-generation-binaries"><a class="header" href="#compile-or-download-the-witness-generation-binaries">Compile or download the witness generation binaries</a></h3>
<p>You may download precompiled witness generation binaries but there is no guarantee that they will work on your machine.</p>
<pre><code class="language-bash">mkdir -p zkeys &amp;&amp; \
wget -O ProcessMessages_10-2-1-2.test https://macitestcircuits.blob.core.windows.net/test/ProcessMessages_10-2-1-2.test &amp;&amp; \
wget -O TallyVotes_10-1-2.test https://macitestcircuits.blob.core.windows.net/test/TallyVotes_10-1-2.test
</code></pre>
<p>Otherwise, you may compile them yourself.</p>
<p>From the main <code>maci/cli</code> directory, run:</p>
<pre><code>npx zkey-manager compile -c ./zkeys.config.yml
</code></pre>
<p>You should see the following files in <code>cli/zkeys/</code>:</p>
<pre><code>ProcessMessages_10-2-1-2.test
ProcessMessages_10-2-1-2.test.0.zkey
TallyVotes_10-1-2.test
TallyVotes_10-1-2.test.0.zkey
</code></pre>
<h3 id="check-the-rapidsnark-binary"><a class="header" href="#check-the-rapidsnark-binary">Check the Rapidsnark binary</a></h3>
<p>Next, ensure that the <code>rapidsnark</code> <code>prover</code> binary is in
<code>~/rapidsnark/build/prover</code>.</p>
<h3 id="run-cli-tests"><a class="header" href="#run-cli-tests">Run CLI tests</a></h3>
<p>In <code>maci/cli/</code>, run:</p>
<pre><code class="language-bash">./test.sh
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>
        
        

    </body>
</html>
